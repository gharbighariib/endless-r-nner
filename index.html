<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Endless r√ºnner - Shop Edition</title>
    <style>
        /* CSS STYLES */
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a2e;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            background: #16213e;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI OVERLAY */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 20px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .hud-stat {
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 5px;
        }

        .coin-display { color: #ffd700; }

        /* MENUS */
        .menu-content {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #e94560;
            border-radius: 16px;
            padding: 20px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 { margin: 0 0 10px 0; color: #e94560; text-transform: uppercase; letter-spacing: 2px; }
        .subtitle { color: #ccc; font-size: 0.9rem; margin-bottom: 15px; }

        /* BUTTONS */
        .btn-stack { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }

        button {
            border: none;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: transform 0.1s;
        }
        button:hover { transform: scale(1.03); filter: brightness(1.1); }
        button:active { transform: scale(0.98); }

        .btn-easy { background: #2ecc71; }
        .btn-normal { background: #3498db; }
        .btn-hard { background: #e74c3c; }
        .btn-shop { background: #9b59b6; }
        .btn-back { background: #34495e; margin-top: 10px; }

        /* SHOP ITEMS */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .shop-item {
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .shop-item:hover { background: rgba(255,255,255,0.1); }

        .shop-item.selected { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .shop-item.locked { opacity: 0.6; }

        .color-preview {
            width: 30px;
            height: 30px;
            margin: 0 auto 5px;
            border-radius: 4px;
            box-shadow: 0 0 10px currentColor;
        }

        .price-tag {
            font-size: 0.8rem;
            color: #ffd700;
            font-weight: bold;
        }

        .owned-tag {
            font-size: 0.8rem;
            color: #2ecc71;
            font-weight: bold;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .hud-badge {
            display: none; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD -->
        <div id="ui-hud" class="hud hidden">
            <div>
                <div class="hud-stat" id="score-display">Score: 0</div>
                <div class="hud-stat coin-display">Coins: <span id="coin-display-hud">0</span></div>
            </div>
            <div>
                <div id="badge-slow" class="hud-badge" style="color:#00ffcc; border:1px solid #00ffcc;">SLOW!</div>
                <div id="badge-mult" class="hud-badge" style="color:#e74c3c; border:1px solid #e74c3c;">COIN x2!</div>
            </div>
        </div>

        <!-- MENU LAYER -->
        <div id="ui-menu" class="ui-layer">

            <!-- START SCREEN -->
            <div id="start-screen" class="menu-content">
                <h1>Endless r√ºnner</h1>
                <div class="subtitle">Dodge. Collect. Customize.</div>
                <div class="subtitle" style="color:#ffd700">Coins: <span id="coin-display-menu">0</span></div>

                <div class="btn-stack">
                    <button class="btn-easy" onclick="game.start('easy')">Easy</button>
                    <button class="btn-normal" onclick="game.start('normal')">Normal</button>
                    <button class="btn-hard" onclick="game.start('hard')">Hard</button>
                </div>

                <button class="btn-shop" onclick="ui.openShop()">Color Shop</button>

                <p style="font-size:0.8rem; color:#888; margin-top:15px;">
                    ‚å®Ô∏è Arrows/A-D to Move<br>
                    üì± Tap Left/Right Sides
                </p>
            </div>

            <!-- SHOP SCREEN -->
            <div id="shop-screen" class="menu-content hidden">
                <h1>Color Shop</h1>
                <div class="subtitle">Current Coins: <span id="coin-display-shop" style="color:#ffd700">0</span></div>

                <div class="shop-grid" id="shop-grid">
                    <!-- Items injected via JS -->
                </div>

                <button class="btn-back" onclick="ui.openMenu()">Back</button>
            </div>

            <!-- GAME OVER SCREEN -->
            <div id="game-over-screen" class="menu-content hidden">
                <h1>Game Over</h1>
                <div class="subtitle">Final Score: <span id="final-score-val">0</span></div>
                <div class="subtitle">Coins Collected: <span id="session-coins" style="color:#ffd700">0</span></div>

                <div class="btn-stack">
                    <button class="btn-normal" onclick="game.restart()">Try Again</button>
                    <button class="btn-back" onclick="game.returnToMenu()">Menu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * CONFIG & DATA
         */
        const CONFIG = {
            playerSpeed: 400,
            baseEnemySpeed: 250,
            spawnRate: 800,
            difficultyStep: 0.05,
            powerUpDuration: 5000, // Slightly longer for coin earning
            slowFactor: 0.4
        };

        const DIFFICULTY = {
            easy:   { speedMod: 0.6, spawnMod: 1.5, scoreMod: 0.5, coinMod: 0.5 },
            normal: { speedMod: 1.0, spawnMod: 1.0, scoreMod: 1.0, coinMod: 1.0 },
            hard:   { speedMod: 1.6, spawnMod: 0.6, scoreMod: 2.0, coinMod: 1.5 }
        };

        // EXPANDED COLOR PALETTE
        const COLORS = [
            { id: 'cyan', name: 'Neon Cyan', hex: '#00f0ff', price: 0 },
            { id: 'green', name: 'Matrix Green', hex: '#00ff00', price: 100 },
            { id: 'orange', name: 'Plasma Orange', hex: '#ff9900', price: 250 },
            { id: 'purple', name: 'Void Purple', hex: '#9b59b6', price: 500 },
            { id: 'pink', name: 'Cyber Pink', hex: '#ff00ff', price: 750 },
            { id: 'yellow', name: 'Volt Yellow', hex: '#ffff00', price: 1000 },
            { id: 'white', name: 'Star White', hex: '#ffffff', price: 1500 },
            { id: 'red', name: 'Blood Red', hex: '#ff0000', price: 2000 }
        ];

        // --- ENGINE SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = document.getElementById('game-container').offsetWidth;
            canvas.height = document.getElementById('game-container').offsetHeight;
            game.player.w = canvas.width * 0.06;
            game.player.h = game.player.w;
        }
        window.addEventListener('resize', resize);

        // --- SAVE DATA ---
        let saveData = JSON.parse(localStorage.getItem('endlessRunnerSave')) || {
            coins: 0,
            highScore: 0,
            unlockedColors: ['cyan'],
            selectedColor: 'cyan'
        };

        // --- GAME LOGIC ---
        const game = {
            state: 'START', // START, PLAYING, GAMEOVER
            score: 0,
            sessionCoins: 0,
            currentDifficulty: DIFFICULTY.normal,
            lastDifficultyKey: 'normal',

            player: { x: 0, y: 0, w: 30, h: 30, color: COLORS[0].hex },
            enemies: [],
            coins: [],
            powerUps: [], // 0: Slow, 1: Coin x2
            texts: [], // Floating text

            lastTime: 0,
            spawnTimer: 0,
            coinSpawnTimer: 0,
            currentSpeed: 0,

            isSlowed: false,
            isCoinMult: false, // New state
            timerSlow: 0,
            timerMult: 0,

            keys: { ArrowLeft: false, ArrowRight: false, a: false, d: false },
            touch: { active: false, x: 0 },

            init: function() {
                resize();

                const savedColor = COLORS.find(c => c.id === saveData.selectedColor);
                this.player.color = savedColor ? savedColor.hex : COLORS[0].hex;

                ui.updateMoney();

                window.addEventListener('keydown', e => this.keys[e.key] = true);
                window.addEventListener('keyup', e => this.keys[e.key] = false);

                canvas.addEventListener('touchstart', e => { e.preventDefault(); this.touch.active = true; this.touch.x = e.touches[0].clientX; }, {passive: false});
                canvas.addEventListener('touchmove', e => { e.preventDefault(); if(this.touch.active) this.touch.x = e.touches[0].clientX; }, {passive: false});
                canvas.addEventListener('touchend', e => { e.preventDefault(); this.touch.active = false; }, {passive: false});

                requestAnimationFrame(t => this.loop(t));
            },

            start: function(difficulty) {
                this.currentDifficulty = DIFFICULTY[difficulty];
                this.lastDifficultyKey = difficulty;

                this.score = 0;
                this.sessionCoins = 0;
                this.enemies = [];
                this.coins = [];
                this.powerUps = [];
                this.texts = [];
                this.currentSpeed = CONFIG.baseEnemySpeed;
                this.spawnTimer = 0;
                this.coinSpawnTimer = 0;
                this.isSlowed = false;
                this.isCoinMult = false;
                this.timerSlow = 0;
                this.timerMult = 0;

                this.player.y = canvas.height - this.player.h - 20;
                this.player.x = canvas.width / 2 - this.player.w / 2;

                this.state = 'PLAYING';
                ui.updateState();
            },

            restart: function() {
                this.start(this.lastDifficultyKey);
            },

            returnToMenu: function() {
                this.state = 'START';
                ui.updateState();
            },

            gameOver: function() {
                this.state = 'GAMEOVER';

                if (this.score > saveData.highScore) {
                    saveData.highScore = Math.floor(this.score);
                }
                saveData.coins += this.sessionCoins;

                localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                ui.updateMoney();

                document.getElementById('final-score-val').innerText = Math.floor(this.score);
                document.getElementById('session-coins').innerText = `+${this.sessionCoins}`;

                this.updateUI();
                ui.updateState();
                this.draw();
            },

            update: function(dt) {
                if (this.state !== 'PLAYING') return;

                // 1. Movement
                let move = 0;
                if (this.keys.ArrowLeft || this.keys.a) move = -1;
                if (this.keys.ArrowRight || this.keys.d) move = 1;
                if (this.touch.active) {
                    const centerX = window.innerWidth / 2;
                    if (this.touch.x < centerX) move = -1; else move = 1;
                }

                this.player.x += move * (CONFIG.playerSpeed * (canvas.width/500)) * dt;
                if (this.player.x < 0) this.player.x = 0;
                if (this.player.x + this.player.w > canvas.width) this.player.x = canvas.width - this.player.w;

                // 2. Difficulty
                this.currentSpeed += CONFIG.difficultyStep * dt * 10;
                if (this.isSlowed) { this.timerSlow -= dt * 1000; if(this.timerSlow <= 0) this.isSlowed = false; }
                if (this.isCoinMult) { this.timerMult -= dt * 1000; if(this.timerMult <= 0) this.isCoinMult = false; }
                let actualSpeed = this.isSlowed ? this.currentSpeed * CONFIG.slowFactor : this.currentSpeed;

                // 3. Spawn Enemies
                let rate = CONFIG.spawnRate * this.currentDifficulty.spawnMod;
                this.spawnTimer -= dt * 1000;
                if (this.spawnTimer <= 0) {
                    let size = this.player.w + (Math.random() * 20);
                    this.enemies.push({ x: Math.random() * (canvas.width - size), y: -size, w: size, h: size });
                    this.spawnTimer = rate * (0.8 + Math.random() * 0.4);
                }

                // 4. Spawn Coins
                if (Math.random() < 0.02) {
                    this.coins.push({
                        x: Math.random() * (canvas.width - 20),
                        y: -20, w: 20, h: 20
                    });
                }

                // 5. Update Enemies
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    let e = this.enemies[i];
                    e.y += actualSpeed * dt;
                    if (this.rectIntersect(this.player.x, this.player.y, this.player.w, this.player.h, e.x, e.y, e.w, e.h)) {
                        this.gameOver();
                        return;
                    }
                    if (e.y > canvas.height) {
                        this.enemies.splice(i, 1);
                        let pts = 10 * this.currentDifficulty.scoreMod;
                        this.score += pts;
                    }
                }

                // 6. Update Coins
                for (let i = this.coins.length - 1; i >= 0; i--) {
                    let c = this.coins[i];
                    c.y += actualSpeed * dt;
                    if (this.rectIntersect(this.player.x, this.player.y, this.player.w, this.player.h, c.x, c.y, c.w, c.h)) {
                        // Logic: If Red Orb active, +2 coins, else +1
                        let earned = this.isCoinMult ? 2 : 1;
                        this.sessionCoins += earned;

                        // Floating Text
                        this.texts.push({
                            x: c.x + c.w/2, y: c.y,
                            text: `+${earned}`,
                            color: earned === 2 ? '#e74c3c' : '#ffd700',
                            life: 1.0, vy: -100
                        });

                        this.coins.splice(i, 1);
                    } else if (c.y > canvas.height) {
                        this.coins.splice(i, 1);
                    }
                }

                // 7. Powerups (0=Slow, 1=CoinMult)
                if (Math.random() < 0.005) {
                    let type = Math.random() > 0.5 ? 0 : 1;
                    this.powerUps.push({ x: Math.random() * (canvas.width - 25), y: -25, w: 25, h: 25, type: type });
                }
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    let p = this.powerUps[i];
                    p.y += actualSpeed * dt;
                    if (this.rectIntersect(this.player.x, this.player.y, this.player.w, this.player.h, p.x, p.y, p.w, p.h)) {
                        if (p.type === 0) { this.isSlowed = true; this.timerSlow = CONFIG.powerUpDuration; }
                        else { this.isCoinMult = true; this.timerMult = CONFIG.powerUpDuration; }
                        this.powerUps.splice(i, 1);
                    } else if (p.y > canvas.height) { this.powerUps.splice(i, 1); }
                }

                // 8. Floating Texts
                for (let i = this.texts.length - 1; i >= 0; i--) {
                    let t = this.texts[i];
                    t.y += t.vy * dt;
                    t.life -= dt * 1.5; // Fade out speed
                    if (t.life <= 0) this.texts.splice(i, 1);
                }

                this.updateUI();
            },

            updateUI: function() {
                document.getElementById('score-display').innerText = `Score: ${Math.floor(this.score)}`;
                document.getElementById('coin-display-hud').innerText = saveData.coins + this.sessionCoins;

                document.getElementById('badge-slow').style.display = this.isSlowed ? 'block' : 'none';
                document.getElementById('badge-mult').style.display = this.isCoinMult ? 'block' : 'none';
            },

            draw: function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw Player
                ctx.shadowBlur = 15; ctx.shadowColor = this.player.color;
                ctx.fillStyle = this.player.color;
                ctx.fillRect(this.player.x, this.player.y, this.player.w, this.player.h);
                ctx.fillStyle = '#ffffff'; ctx.shadowBlur = 0;
                ctx.fillRect(this.player.x + 4, this.player.y + 4, this.player.w - 8, this.player.h - 8);

                // Draw Enemies
                ctx.fillStyle = '#e94560';
                for(let e of this.enemies) ctx.fillRect(e.x, e.y, e.w, e.h);

                // Draw Coins
                ctx.fillStyle = '#ffd700'; ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
                for(let c of this.coins) {
                    ctx.beginPath();
                    ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/2, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#ffea00';
                    ctx.beginPath();
                    ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/4, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#ffd700';
                }
                ctx.shadowBlur = 0;

                // Draw Powerups
                for(let p of this.powerUps) {
                    if(p.type === 0) { // SLOW
                        ctx.fillStyle = '#00ffcc'; ctx.shadowBlur=10; ctx.shadowColor='#00ffcc';
                        ctx.beginPath(); ctx.arc(p.x+p.w/2, p.y+p.h/2, p.w/2, 0, Math.PI*2); ctx.fill();
                    } else { // COIN MULT
                        ctx.fillStyle = '#e74c3c'; ctx.shadowBlur=10; ctx.shadowColor='#e74c3c';
                        ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(Math.PI/4);
                        ctx.fillRect(-p.w/2, -p.w/2, p.w, p.w); ctx.restore();
                    }
                    ctx.shadowBlur=0;
                }

                // Draw Floating Text
                for(let t of this.texts) {
                    ctx.fillStyle = t.color;
                    ctx.globalAlpha = t.life;
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(t.text, t.x, t.y);
                    ctx.globalAlpha = 1.0;
                }

                if(this.isSlowed) { ctx.fillStyle='rgba(0,255,204,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
                if(this.isCoinMult) { ctx.fillStyle='rgba(231, 76, 60,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
            },

            loop: function(timestamp) {
                let dt = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;
                if (dt > 0.1) dt = 0.1;
                this.update(dt);
                this.draw();
                requestAnimationFrame(t => this.loop(t));
            },

            rectIntersect: function(x1, y1, w1, h1, x2, y2, w2, h2) {
                return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
            }
        };

        // --- UI LOGIC ---
        const ui = {
            screens: {
                start: document.getElementById('start-screen'),
                shop: document.getElementById('shop-screen'),
                gameover: document.getElementById('game-over-screen'),
                hud: document.getElementById('ui-hud'),
                menu: document.getElementById('ui-menu')
            },

            init: function() {
                this.renderShop();
            },

            updateMoney: function() {
                const total = saveData.coins;
                document.getElementById('coin-display-menu').innerText = total;
                document.getElementById('coin-display-shop').innerText = total;
            },

            updateState: function() {
                const state = game.state;
                this.screens.menu.classList.add('hidden');
                this.screens.hud.classList.add('hidden');

                Object.values(this.screens).forEach(s => {
                    if(s !== this.screens.menu && s !== this.screens.hud) s.classList.add('hidden');
                });

                if (state === 'START') {
                    this.screens.menu.classList.remove('hidden');
                    this.screens.start.classList.remove('hidden');
                    this.updateMoney();
                } else if (state === 'PLAYING') {
                    this.screens.menu.classList.add('hidden');
                    this.screens.hud.classList.remove('hidden');
                } else if (state === 'GAMEOVER') {
                    this.screens.menu.classList.remove('hidden');
                    this.screens.gameover.classList.remove('hidden');
                }
            },

            openShop: function() {
                this.screens.start.classList.add('hidden');
                this.screens.shop.classList.remove('hidden');
                this.renderShop();
            },

            openMenu: function() {
                this.screens.shop.classList.add('hidden');
                this.screens.start.classList.remove('hidden');
            },

            renderShop: function() {
                const grid = document.getElementById('shop-grid');
                grid.innerHTML = '';

                COLORS.forEach(color => {
                    const isUnlocked = saveData.unlockedColors.includes(color.id);
                    const isSelected = saveData.selectedColor === color.id;

                    const item = document.createElement('div');
                    item.className = `shop-item ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;

                    let html = `
                        <div class="color-preview" style="background-color: ${color.hex}; color: ${color.hex}"></div>
                        <div style="font-weight:bold; margin-bottom:5px">${color.name}</div>
                    `;

                    if (isSelected) {
                        html += `<div class="owned-tag">OWNED & EQUIPPED</div>`;
                    } else if (isUnlocked) {
                        html += `<div class="owned-tag">OWNED</div>`;
                    } else {
                        html += `<div class="price-tag">${color.price} Coins</div>`;
                    }

                    item.innerHTML = html;

                    item.onclick = () => {
                        if (isUnlocked) {
                            saveData.selectedColor = color.id;
                            game.player.color = color.hex;
                            localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                            this.renderShop();
                        } else {
                            if (saveData.coins >= color.price) {
                                saveData.coins -= color.price;
                                saveData.unlockedColors.push(color.id);
                                saveData.selectedColor = color.id;
                                game.player.color = color.hex;
                                localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                                this.updateMoney();
                                this.renderShop();
                            } else {
                                item.style.backgroundColor = 'rgba(255,0,0,0.2)';
                                setTimeout(() => item.style.backgroundColor = '', 200);
                            }
                        }
                    };

                    grid.appendChild(item);
                });
            }
        };

        game.init();
        ui.init();

    </script>
</body>
</html>
