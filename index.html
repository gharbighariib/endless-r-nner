<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Endless rünner - Final</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --bg-color: #1a1a2e;
            --ui-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --accent-color: #e94560;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: var(--ui-font);
            overflow: hidden; /* Prevent scrolling */
            touch-action: none; /* Disable mobile zoom/scroll */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px; /* Constrain width for playability on desktop */
            background: #16213e;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- UI OVERLAYS --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to canvas when not on a button */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* HUD (Heads Up Display) */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 20px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .hud-stat {
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 5px;
        }

        .coin-display { color: #ffd700; }

        /* PAUSE BUTTON */
        #btn-pause {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            pointer-events: auto; /* Clickable */
            transition: 0.2s;
        }
        #btn-pause:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }

        /* MENUS */
        .menu-content {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid var(--accent-color);
            border-radius: 16px;
            padding: 20px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            pointer-events: auto; /* Re-enable clicks for menu */
            backdrop-filter: blur(5px);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
        }

        h1 { margin: 0 0 10px 0; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; }
        .subtitle { color: #ccc; font-size: 0.9rem; margin-bottom: 15px; }
        .highscore-text { color: #ffd700; font-weight: bold; margin-bottom: 15px; }
        .new-record { color: #e74c3c; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; display: none; animation: pulse 0.5s infinite alternate;}

        /* BUTTONS */
        .btn-stack { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        button {
            border: none; padding: 12px; font-size: 1rem; font-weight: bold;
            text-transform: uppercase; border-radius: 8px; cursor: pointer;
            color: white; transition: transform 0.1s;
        }
        button:hover { transform: scale(1.03); filter: brightness(1.1); }
        button:active { transform: scale(0.98); }
        .btn-easy { background: #2ecc71; } .btn-normal { background: #3498db; } .btn-hard { background: #e74c3c; }
        .btn-shop { background: #9b59b6; } .btn-back { background: #34495e; margin-top: 10px; }
        .btn-resume { background: #00ffcc; } /* Cyan for resume */

        /* SHOP */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .shop-item {
            background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px;
            padding: 10px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .shop-item:hover { background: rgba(255,255,255,0.1); }
        .shop-item.selected { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .shop-item.locked { opacity: 0.6; }
        .color-preview { width: 30px; height: 30px; margin: 0 auto 5px; border-radius: 4px; box-shadow: 0 0 10px currentColor; }
        .price-tag { font-size: 0.8rem; color: #ffd700; font-weight: bold; }
        .owned-tag { font-size: 0.8rem; color: #2ecc71; font-weight: bold; }

        /* UTILS */
        .hidden { display: none !important; }
        .hud-badge { display: none; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD -->
        <div id="ui-hud" class="hud hidden">
            <div>
                <div class="hud-stat" id="score-display">Score: 0</div>
                <div class="hud-stat coin-display">Coins: <span id="coin-display-hud">0</span></div>
            </div>
            <!-- BADGES -->
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <div id="badge-slow" class="hud-badge" style="color:#00ffcc; border:1px solid #00ffcc;">SLOW!</div>
                <div id="badge-mult" class="hud-badge" style="color:#e74c3c; border:1px solid #e74c3c;">COIN x2!</div>
            </div>
            
            <!-- PAUSE BUTTON -->
            <div id="btn-pause">II</div>
        </div>

        <!-- MENU LAYER -->
        <div id="ui-layer" class="ui-layer">
            
            <!-- START SCREEN -->
            <div id="start-screen" class="menu-content">
                <h1>Endless rünner</h1>
                <div class="subtitle">Dodge. Collect. Customize.</div>
                <div class="subtitle highscore-text">High Score: <span id="highscore-menu">0</span></div>

                <div class="btn-stack">
                    <button class="btn-easy" onclick="game.startGame('easy')">Easy</button>
                    <button class="btn-normal" onclick="game.startGame('normal')">Normal</button>
                    <button class="btn-hard" onclick="game.startGame('hard')">Hard</button>
                </div>

                <button class="btn-shop" onclick="ui.showScreen('shop')">Color Shop</button>
                
                <p style="font-size:0.8rem; color:#888; margin-top:15px;">
                    ⌨️ Arrows/A-D to Move<br>
                    <strong style="color:white">Press 'P' to Pause</strong>
                </p>
            </div>

            <!-- SHOP SCREEN -->
            <div id="shop-screen" class="menu-content hidden">
                <h1>Color Shop</h1>
                <div class="subtitle">Coins: <span id="coin-display-shop" style="color:#ffd700">0</span></div>
                <div class="shop-grid" id="shop-grid"></div>
                <button class="btn-back" onclick="ui.showScreen('start')">Back</button>
            </div>

            <!-- PAUSE SCREEN -->
            <div id="pause-screen" class="menu-content hidden">
                <h1 style="color:#00ffcc">PAUSED</h1>
                <div class="subtitle">Game Stopped</div>
                
                <div class="btn-stack">
                    <button class="btn-resume" onclick="game.togglePause()">Resume Game</button>
                    <button class="btn-back" onclick="game.returnToMenu()">Main Menu</button>
                </div>
            </div>

            <!-- GAME OVER SCREEN -->
            <div id="game-over-screen" class="menu-content hidden">
                <h1>Game Over</h1>
                <div id="new-record" class="new-record">NEW HIGH SCORE!</div>
                <div class="subtitle">Final Score: <span id="final-score-val">0</span></div>
                <div class="subtitle highscore-text">High Score: <span id="highscore-gameover">0</span></div>
                <div class="subtitle">Coins Collected: <span id="session-coins" style="color:#ffd700">0</span></div>
                
                <div class="btn-stack">
                    <button class="btn-normal" onclick="game.startGame('restart')">Try Again</button>
                    <button class="btn-back" onclick="game.returnToMenu()">Menu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- --- 2. JAVASCRIPT LOGIC --- -->
    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            playerSpeed: 400,
            baseEnemySpeed: 250,
            spawnRate: 800,
            difficultyStep: 0.05,
            powerUpDuration: 5000,
            slowFactor: 0.4
        };

        const DIFFICULTY = {
            easy:   { speedMod: 0.6, spawnMod: 1.5, scoreMod: 0.5, coinMod: 0.5 },
            normal: { speedMod: 1.0, spawnMod: 1.0, scoreMod: 1.0, coinMod: 1.0 },
            hard:   { speedMod: 1.6, spawnMod: 0.6, scoreMod: 2.0, coinMod: 1.5 }
        };

        const COLORS = [
            { id: 'cyan', name: 'Neon Cyan', hex: '#00f0ff', price: 0 },
            { id: 'green', name: 'Matrix Green', hex: '#00ff00', price: 100 },
            { id: 'orange', name: 'Plasma Orange', hex: '#ff9900', price: 250 },
            { id: 'purple', name: 'Void Purple', hex: '#9b59b6', price: 500 },
            { id: 'pink', name: 'Cyber Pink', hex: '#ff00ff', price: 750 },
            { id: 'yellow', name: 'Volt Yellow', hex: '#ffff00', price: 1000 },
            { id: 'white', name: 'Star White', hex: '#ffffff', price: 1500 },
            { id: 'red', name: 'Blood Red', hex: '#ff0000', price: 2000 }
        ];

        // --- ENGINE SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = document.getElementById('game-wrapper').offsetWidth;
            canvas.height = document.getElementById('game-wrapper').offsetHeight;
            game.player.w = canvas.width * 0.06;
            game.player.h = game.player.w; 
        }
        window.addEventListener('resize', resize);

        // --- SAVE DATA ---
        let saveData = JSON.parse(localStorage.getItem('endlessRunnerSave')) || {
            coins: 0,
            highScore: 0,
            unlockedColors: ['cyan'],
            selectedColor: 'cyan'
        };

        // --- GAME OBJECT ---
        const game = {
            state: 'START', // START, PLAYING, PAUSED, GAMEOVER
            score: 0,
            sessionCoins: 0,
            currentDifficulty: DIFFICULTY.normal,
            lastDifficultyKey: 'normal',
            
            player: { x: 0, y: 0, w: 30, h: 30, color: COLORS[0].hex },
            enemies: [],
            coins: [], 
            powerUps: [], // 0: Slow, 1: Coin x2
            floatingTexts: [],
            
            lastTime: 0,
            spawnTimer: 0,
            currentSpeed: 0,
            
            isSlowed: false,
            isCoinMult: false,
            timerSlow: 0,
            timerMult: 0,

            inputs: { left: false, right: false },

            init: function() {
                resize();
                const savedColor = COLORS.find(c => c.id === saveData.selectedColor);
                this.player.color = savedColor ? savedColor.hex : COLORS[0].hex;

                ui.updateMoney();
                ui.updateHighScore();

                // Keyboard Inputs
                window.addEventListener('keydown', e => {
                    // MOVEMENT
                    if (e.key === 'ArrowLeft' || e.key === 'a') this.inputs.left = true;
                    if (e.key === 'ArrowRight' || e.key === 'd') this.inputs.right = true;

                    // PAUSE INPUT
                    if ((e.key === 'p' || e.key === 'P') && this.state === 'PLAYING') {
                        this.togglePause();
                    }
                });

                window.addEventListener('keyup', e => {
                    if (e.key === 'ArrowLeft' || e.key === 'a') this.inputs.left = false;
                    if (e.key === 'ArrowRight' || e.key === 'd') this.inputs.right = false;
                });

                // Touch Inputs
                const handleTouch = (x) => {
                    const rect = canvas.getBoundingClientRect();
                    const touchX = x - rect.left;
                    if (touchX < rect.width / 2) {
                        this.inputs.left = true; this.inputs.right = false;
                    } else {
                        this.inputs.left = false; this.inputs.right = true;
                    }
                };

                canvas.addEventListener('touchstart', e => { 
                    e.preventDefault(); 
                    handleTouch(e.touches[0].clientX);
                }, {passive: false});
                canvas.addEventListener('touchmove', e => { 
                    e.preventDefault(); 
                    handleTouch(e.touches[0].clientX);
                }, {passive: false});
                canvas.addEventListener('touchend', e => { 
                    e.preventDefault(); 
                    this.inputs.left = false; this.inputs.right = false;
                }, {passive: false});

                // Auto-Pause on Tab Switch
                const pauseHandler = () => { if (this.state === 'PLAYING') this.togglePause(true); };
                document.addEventListener('visibilitychange', () => { if(document.hidden) pauseHandler(); });
                window.addEventListener('blur', pauseHandler);

                // Pause Button Click
                document.getElementById('btn-pause').addEventListener('click', () => {
                    if (this.state === 'PLAYING' || this.state === 'PAUSED') {
                        this.togglePause();
                    }
                });

                requestAnimationFrame(t => this.loop(t));
            },

            // Toggle Pause Function
            togglePause: function(forcePause = false) {
                if (this.state === 'PLAYING') {
                    this.state = 'PAUSED';
                    ui.showScreen('pause');
                } else if (this.state === 'PAUSED') {
                    this.state = 'PLAYING';
                    this.lastTime = performance.now(); // Reset timer to prevent jump
                    ui.showScreen('hud');
                }
            },

            startGame: function(difficulty) {
                if (difficulty === 'restart') difficulty = this.lastDifficultyKey;
                
                this.state = 'PLAYING';
                this.currentDifficulty = DIFFICULTY[difficulty];
                this.lastDifficultyKey = difficulty;
                
                this.score = 0;
                this.sessionCoins = 0;
                this.enemies = []; this.coins = []; this.powerUps = []; this.floatingTexts = [];
                this.currentSpeed = CONFIG.baseEnemySpeed;
                this.spawnTimer = 0;
                this.isSlowed = false; this.isCoinMult = false; this.timerSlow = 0; this.timerMult = 0;
                this.player.y = canvas.height - this.player.h - 20;
                this.player.x = canvas.width / 2 - this.player.w / 2;

                ui.showScreen('hud');
            },

            returnToMenu: function() {
                this.state = 'START';
                ui.showScreen('start');
            },

            gameOver: function() {
                this.state = 'GAMEOVER';
                let isNewRecord = false;
                if (this.score > saveData.highScore) {
                    saveData.highScore = Math.floor(this.score);
                    isNewRecord = true;
                }
                saveData.coins += this.sessionCoins;
                localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                
                ui.updateHighScore();
                document.getElementById('final-score-val').innerText = Math.floor(this.score);
                document.getElementById('session-coins').innerText = `+${this.sessionCoins}`;
                const recMsg = document.getElementById('new-record');
                recMsg.style.display = isNewRecord ? 'block' : 'none';

                ui.showScreen('gameover');
            },

            update: function(dt) {
                if (this.state !== 'PLAYING') return;

                // Movement
                let move = 0;
                if (this.inputs.left) move = -1;
                if (this.inputs.right) move = 1;
                this.player.x += move * (CONFIG.playerSpeed * (canvas.width/500)) * dt;
                if (this.player.x < 0) this.player.x = 0;
                if (this.player.x + this.player.w > canvas.width) this.player.x = canvas.width - this.player.w;

                // Difficulty & Speed
                this.currentSpeed += CONFIG.difficultyStep * dt * 10; 
                if (this.isSlowed) { this.timerSlow -= dt * 1000; if(this.timerSlow <= 0) this.isSlowed = false; }
                if (this.isCoinMult) { this.timerMult -= dt * 1000; if(this.timerMult <= 0) this.isCoinMult = false; }
                let actualSpeed = this.isSlowed ? this.currentSpeed * CONFIG.slowFactor : this.currentSpeed;

                // Spawning
                let rate = CONFIG.spawnRate * this.currentDifficulty.spawnMod;
                this.spawnTimer -= dt * 1000;
                if (this.spawnTimer <= 0) {
                    let size = this.player.w + (Math.random() * 20);
                    this.enemies.push({ x: Math.random() * (canvas.width - size), y: -size, w: size, h: size });
                    this.spawnTimer = rate * (0.8 + Math.random() * 0.4);
                }
                if (Math.random() < 0.02) {
                    this.coins.push({ x: Math.random() * (canvas.width - 20), y: -20, w: 20, h: 20 });
                }
                if (Math.random() < 0.005) {
                    let type = Math.random() > 0.5 ? 0 : 1;
                    this.powerUps.push({ x: Math.random() * (canvas.width - 25), y: -25, w: 25, h: 25, type: type });
                }

                // Entity Updates (Enemies)
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    let e = this.enemies[i]; e.y += actualSpeed * dt;
                    if (this.checkCollision(this.player, e)) { this.gameOver(); return; }
                    if (e.y > canvas.height) { this.enemies.splice(i,1); this.score += 10 * this.currentDifficulty.scoreMod; }
                }

                // Entity Updates (Coins)
                for (let i = this.coins.length - 1; i >= 0; i--) {
                    let c = this.coins[i]; c.y += actualSpeed * dt;
                    if (this.checkCollision(this.player, c)) {
                        let earned = this.isCoinMult ? 2 : 1;
                        this.sessionCoins += earned;
                        this.floatingTexts.push({ x: c.x + c.w/2, y: c.y, text: `+${earned}`, color: earned === 2 ? '#e74c3c' : '#ffd700', life: 1.0, vy: -100 });
                        this.coins.splice(i,1);
                    } else if (c.y > canvas.height) { this.coins.splice(i,1); }
                }

                // Entity Updates (Powerups)
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    let p = this.powerUps[i]; p.y += actualSpeed * dt;
                    if (this.checkCollision(this.player, p)) {
                        if (p.type === 0) { this.isSlowed = true; this.timerSlow = CONFIG.powerUpDuration; }
                        else { this.isCoinMult = true; this.timerMult = CONFIG.powerUpDuration; }
                        this.powerUps.splice(i,1);
                    } else if (p.y > canvas.height) { this.powerUps.splice(i,1); }
                }

                // Texts
                for (let i = this.floatingTexts.length - 1; i >= 0; i--) {
                    let t = this.floatingTexts[i]; t.y += t.vy * dt; t.life -= dt * 1.5;
                    if(t.life <= 0) this.floatingTexts.splice(i,1);
                }

                ui.updateHUD(this.score, saveData.coins + this.sessionCoins, this.isSlowed, this.isCoinMult);
            },

            draw: function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (this.state !== 'PLAYING' && this.state !== 'PAUSED' && this.state !== 'GAMEOVER') return;

                // Player
                ctx.save();
                ctx.shadowBlur = 15; ctx.shadowColor = this.player.color;
                ctx.fillStyle = this.player.color;
                ctx.fillRect(this.player.x, this.player.y, this.player.w, this.player.h);
                ctx.fillStyle = '#ffffff'; ctx.shadowBlur = 0;
                ctx.fillRect(this.player.x + 4, this.player.y + 4, this.player.w - 8, this.player.h - 8);
                ctx.restore();

                // Entities
                ctx.fillStyle = '#e94560';
                for(let e of this.enemies) ctx.fillRect(e.x, e.y, e.w, e.h);

                ctx.fillStyle = '#ffd700'; ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
                for(let c of this.coins) {
                    ctx.beginPath(); ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/2, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#ffea00'; ctx.beginPath(); ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/4, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#ffd700';
                }
                ctx.shadowBlur = 0;

                for(let p of this.powerUps) {
                    if(p.type === 0) { 
                        ctx.fillStyle = '#00ffcc'; ctx.shadowBlur=10; ctx.shadowColor='#00ffcc';
                        ctx.beginPath(); ctx.arc(p.x+p.w/2, p.y+p.h/2, p.w/2, 0, Math.PI*2); ctx.fill();
                    } else { 
                        ctx.fillStyle = '#e74c3c'; ctx.shadowBlur=10; ctx.shadowColor='#e74c3c';
                        ctx.save(); ctx.translate(p.x+p.w/2, p.y+p.h/2); ctx.rotate(Math.PI/4);
                        ctx.fillRect(-p.w/2, -p.w/2, p.w, p.w); ctx.restore();
                    }
                    ctx.shadowBlur=0;
                }

                for(let t of this.floatingTexts) {
                    ctx.fillStyle = t.color; ctx.globalAlpha = t.life;
                    ctx.font = 'bold 16px Arial'; ctx.fillText(t.text, t.x, t.y);
                    ctx.globalAlpha = 1.0;
                }

                if(this.isSlowed) { ctx.fillStyle='rgba(0,255,204,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
                if(this.isCoinMult) { ctx.fillStyle='rgba(231, 76, 60,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
            },

            loop: function(timestamp) {
                let dt = (timestamp - this.lastTime) / 1000;
                // Cap dt so if tab was inactive, we don't teleport
                if (dt > 0.1) dt = 0.1; 
                this.lastTime = timestamp;
                
                this.update(dt);
                this.draw();
                requestAnimationFrame(t => this.loop(t));
            },

            checkCollision: function(r1, r2) {
                return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
                        r1.y < r2.y + r2.h && r1.y + r1.h > r2.y);
            }
        };

        // --- UI HANDLING ---
        const ui = {
            screens: {
                start: document.getElementById('start-screen'),
                shop: document.getElementById('shop-screen'),
                gameover: document.getElementById('game-over-screen'),
                pause: document.getElementById('pause-screen'),
                hud: document.getElementById('ui-hud'),
                layer: document.getElementById('ui-layer')
            },
            
            init: function() { this.renderShop(); },

            updateMoney: function() {
                document.getElementById('coin-display-shop').innerText = saveData.coins;
            },

            updateHighScore: function() {
                const hs = Math.floor(saveData.highScore);
                document.getElementById('highscore-menu').innerText = hs;
                document.getElementById('highscore-gameover').innerText = hs;
            },

            updateHUD: function(score, coins, slow, mult) {
                document.getElementById('score-display').innerText = `Score: ${Math.floor(score)}`;
                document.getElementById('coin-display-hud').innerText = coins;
                document.getElementById('badge-slow').style.display = slow ? 'block' : 'none';
                document.getElementById('badge-mult').style.display = mult ? 'block' : 'none';
            },

            showScreen: function(screenName) {
                // Hide all specific screens
                Object.values(this.screens).forEach(el => {
                    if(el !== this.screens.hud) el.classList.add('hidden');
                });
                
                this.screens.hud.classList.add('hidden');
                this.screens.layer.classList.remove('hidden');

                if (screenName === 'start') {
                    this.screens.start.classList.remove('hidden');
                    this.updateMoney();
                } else if (screenName === 'shop') {
                    this.screens.shop.classList.remove('hidden');
                    this.renderShop();
                } else if (screenName === 'gameover') {
                    this.screens.gameover.classList.remove('hidden');
                } else if (screenName === 'pause') {
                    this.screens.pause.classList.remove('hidden');
                } else if (screenName === 'hud') {
                    this.screens.layer.classList.add('hidden');
                    this.screens.hud.classList.remove('hidden');
                }
            },

            openMenu: function() {
                this.screens.shop.classList.add('hidden');
                this.screens.start.classList.remove('hidden');
            },

            renderShop: function() {
                const grid = document.getElementById('shop-grid');
                grid.innerHTML = '';
                COLORS.forEach(color => {
                    const isUnlocked = saveData.unlockedColors.includes(color.id);
                    const isSelected = saveData.selectedColor === color.id;
                    const item = document.createElement('div');
                    item.className = `shop-item ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;
                    
                    let html = `<div class="color-preview" style="background-color: ${color.hex}"></div><div style="font-weight:bold">${color.name}</div>`;
                    if (isSelected) { html += `<div class="owned-tag">OWNED & EQUIPPED</div>`; }
                    else if (isUnlocked) { html += `<div class="owned-tag">OWNED</div>`; }
                    else { html += `<div class="price-tag">${color.price} Coins</div>`; }

                    item.innerHTML = html;
                    item.onclick = () => {
                        if (isUnlocked) {
                            saveData.selectedColor = color.id;
                            game.player.color = color.hex;
                            localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                            this.renderShop();
                        } else if (saveData.coins >= color.price) {
                            saveData.coins -= color.price;
                            saveData.unlockedColors.push(color.id);
                            saveData.selectedColor = color.id;
                            game.player.color = color.hex;
                            localStorage.setItem('endlessRunnerSave', JSON.stringify(saveData));
                            this.updateMoney();
                            this.renderShop();
                        } else {
                            item.style.backgroundColor = 'rgba(255,0,0,0.2)';
                            setTimeout(() => item.style.backgroundColor = '', 200);
                        }
                    };
                    grid.appendChild(item);
                });
            }
        };

        // Start Game
        game.init();
        ui.init();

    </script>
</body>
</html>
